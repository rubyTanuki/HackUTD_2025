<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thesis Upload</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body {
      background: #0f172a;
      padding: 40px;
    }
  </style>
</head>
<body class="text-white dark:bg-gray-900">
  <!-- üîπ Sticky Navbar -->
<nav class="bg-gray-900 border-b border-gray-700 shadow-md sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
    
    <!-- üñºÔ∏è Left side: Logo + Links -->
    <div class="flex items-center space-x-10">
      <!-- Logo (no circle or border, just image) -->
      <img 
        src="/images/IMG_0222.PNG" 
        alt="Logo" 
        class="w-16 h-16 object-cover"
      >

      <!-- Links -->
      <div class="flex items-center space-x-8">
        <a href="upload.html"
           class="text-blue-400 font-medium transition border-b-2 border-blue-400 pb-1 hover:text-blue-300">
           Home
        </a>
        <a href="about.html"
           class="text-gray-300 font-medium transition border-b-2 border-transparent hover:text-blue-400 hover:border-blue-400 pb-1">
           About Us
        </a>
      </div>
    </div>

  </div>
</nav>


  <div class="max-w-3xl mx-auto">
    <h2 class="text-3xl font-semibold mb-8 text-center">Upload or Paste Your Thesis</h2>

    <form onsubmit="event.preventDefault(); uploadData();">
      <div class="w-full mb-6 border border-gray-700 rounded-lg bg-gray-800 shadow-md">
        <div class="flex items-center justify-between px-3 py-2 border-b border-gray-700 bg-gray-900 rounded-t-lg">
          <div class="flex items-center space-x-2">
            <label for="fileInput" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded cursor-pointer">
              <i class="bi bi-paperclip text-lg"></i>
              <input id="fileInput" type="file" class="hidden" accept=".txt" />
            </label>
          </div>
          <p class="text-xs text-gray-400">or paste below</p>
        </div>

        <div class="px-4 py-3 bg-gray-800 rounded-b-lg">
          <textarea id="dataInput" rows="10"
            class="block w-full text-white bg-gray-800 border-0 focus:ring-0 placeholder-gray-400"
            placeholder="Paste or type your thesis here..." required></textarea>
        </div>
      </div>

      <p id="fileStatus" class="text-center text-gray-400 mb-6">No file selected.</p>

      <div class="text-center">
        <button type="submit"
          class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg focus:ring-4 focus:ring-blue-400 transition">
          Upload
        </button>
      </div>
      <div id="loadingContainer" class="hidden mt-8">
        <div class="w-full bg-gray-700 rounded-full h-1.5 overflow-hidden">
          <div id="loadingBar" class="h-1.5 bg-blue-500 rounded-full w-0 transition-all duration-500"></div>
        </div>
        <p id="loadingText" class="text-center text-gray-400 mt-2 text-sm">Starting upload...</p>
      </div>
    </form>

    <pre id="output" class="mt-8 p-4 bg-gray-900 text-gray-300 rounded overflow-x-auto text-sm whitespace-pre-wrap"></pre>
  </div>

  <script>
    // üìé File input preview
    document.getElementById("fileInput").addEventListener("change", () => {
      const file = document.getElementById("fileInput").files[0];
      const fileStatus = document.getElementById("fileStatus");
  
      if (file) {
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
        fileStatus.textContent = `File attached: ${file.name} (${sizeMB} MB)`;
        fileStatus.classList.add("text-green-400");
      } else {
        fileStatus.textContent = "No file selected.";
        fileStatus.classList.remove("text-green-400");
      }
    });
  
    // Call Backend API
    async function callAPI(thesis) {
      try {
        const response = await fetch("https://oncologic-unpopularly-shirley.ngrok-free.dev/getArticles", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "ngrok-skip-browser-warning": "true"
           },

          body: JSON.stringify({"thesis": thesis }),
          redirect: 'follow'
        });

        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        return await response.json();
      } catch (err) {
        console.error("Error:", err);
        alert("Failed to reach backend. Check if ngrok is active and run via http://localhost (not file://)." + err.message);
        return null;
      }
    }
  
    // üöÄ Upload Function
    async function uploadData() {
      const textarea = document.getElementById("dataInput");
      const textData = textarea.value.trim();
      const output = document.getElementById("output");
      const loadingContainer = document.getElementById("loadingContainer");
      const loadingBar = document.getElementById("loadingBar");
      const loadingText = document.getElementById("loadingText");
  
      if (!textData) {
        alert("Please enter your thesis before uploading!");
        return;
      }
  
      // üü¶ Show progress bar
      loadingBar.style.width = "0%";
      loadingBar.className = "h-1.5 bg-red-600 rounded-full transition-all duration-500";
      loadingContainer.classList.remove("hidden");
      loadingText.textContent = "Uploading your thesis...";
  
      let progress = 0;
      const timer = setInterval(() => {
        // ‚è≥ Slow + smooth increase
        progress += Math.random() * 3; // 1‚Äì3% each step
        if (progress > 90) progress = 90; // stop at 90% until backend done
        loadingBar.style.width = `${progress}%`;
  
        // üé® Color gradient
        if (progress < 30) loadingBar.className = "h-1.5 bg-red-600 rounded-full transition-all duration-500";
        else if (progress < 60) loadingBar.className = "h-1.5 bg-yellow-500 rounded-full transition-all duration-500";
        else if (progress < 85) loadingBar.className = "h-1.5 bg-lime-500 rounded-full transition-all duration-500";
        else loadingBar.className = "h-1.5 bg-green-600 rounded-full transition-all duration-500";
      }, 500);
  
      try {
        const start = performance.now();
        const backendResponse = await callAPI(textData);
        const end = performance.now();
        const duration = ((end - start) / 1000).toFixed(1);
  
        if (!backendResponse) {
          clearInterval(timer);
          loadingText.textContent = "‚ùå Connection failed.";
          return;
        }
  
        // ‚úÖ Backend done ‚Üí complete bar
        clearInterval(timer);
        loadingBar.style.width = "100%";
        loadingBar.className = "h-1.5 bg-blue-600 rounded-full transition-all duration-700";
        loadingText.textContent = `‚úÖ Upload complete (${duration}s)! Redirecting...`;
  
        // Save to localStorage + redirect
        localStorage.setItem("uploadedThesis", textData);
        localStorage.setItem("backendResponse", JSON.stringify(backendResponse));
  
        setTimeout(() => window.location.href = "results.html", 1000);
  
      } catch (error) {
        clearInterval(timer);
        loadingText.textContent = "‚ùå Error connecting to backend.";
        output.textContent = `Error: ${error}`;
        console.error(error);
      }
    }
  </script>
  
</body>
</html>
