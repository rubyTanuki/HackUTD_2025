<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thesis Upload</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body {
      background: #0f172a;
      padding: 40px;
    }
  </style>
</head>
<body class="text-white dark:bg-gray-900">

  <div class="max-w-3xl mx-auto">
    <h2 class="text-3xl font-semibold mb-8 text-center">Upload or Paste Your Thesis</h2>

    <form onsubmit="event.preventDefault(); uploadData();">
      <div class="w-full mb-6 border border-gray-700 rounded-lg bg-gray-800 shadow-md">
        <div class="flex items-center justify-between px-3 py-2 border-b border-gray-700 bg-gray-900 rounded-t-lg">
          <div class="flex items-center space-x-2">
            <label for="fileInput" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded cursor-pointer">
              <i class="bi bi-paperclip text-lg"></i>
              <input id="fileInput" type="file" class="hidden" accept=".txt" />
            </label>
          </div>
          <p class="text-xs text-gray-400">or paste below</p>
        </div>

        <div class="px-4 py-3 bg-gray-800 rounded-b-lg">
          <textarea id="dataInput" rows="10"
            class="block w-full text-white bg-gray-800 border-0 focus:ring-0 placeholder-gray-400"
            placeholder="Paste or type your thesis here..." required></textarea>
        </div>
      </div>

      <p id="fileStatus" class="text-center text-gray-400 mb-6">No file selected.</p>

      <div class="text-center">
        <button type="submit"
          class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg focus:ring-4 focus:ring-blue-400 transition">
          Upload
        </button>
      </div>
    </form>

    <pre id="output" class="mt-8 p-4 bg-gray-900 text-gray-300 rounded overflow-x-auto text-sm whitespace-pre-wrap"></pre>
  </div>

  <script>
    //  Read uploaded text file
    document.getElementById("fileInput").addEventListener("change", async () => {
      const file = document.getElementById("fileInput").files[0];
      const status = document.getElementById("fileStatus");
      const textarea = document.getElementById("dataInput");

      if (file) {
        status.textContent = `File attached: ${file.name}`;
        status.classList.add("text-green-400");
        textarea.value = await file.text();
      } else {
        status.textContent = "No file selected.";
        status.classList.remove("text-green-400");
      }
    });

    // Call Backend API
    async function callAPI(thesis) {
      try {
        const response = await fetch("https://oncologic-unpopularly-shirley.ngrok-free.dev/getArticles", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "ngrok-skip-browser-warning": "true"
           },

          body: JSON.stringify({"thesis": thesis }),
          redirect: 'follow'
        });

        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        return await response.json();
      } catch (err) {
        console.error("Error:", err);
        alert("Failed to reach backend. Check if ngrok is active and run via http://localhost (not file://)." + err.message);
        return null;
      }
    }

    // Upload thesis
    async function uploadData() {
      const textData = document.getElementById("dataInput").value.trim();
      const output = document.getElementById("output");
      if (!textData) return alert("Please paste or type your thesis before uploading!");

      output.textContent = "Uploading...";

      const backendResponse = await callAPI(textData);
      if (!backendResponse) {
        output.textContent = "Connection failed.";
        return;
      }

      localStorage.setItem("uploadedThesis", textData);
      localStorage.setItem("backendResponse", JSON.stringify(backendResponse));

      output.textContent = "Success! Redirecting...";
      setTimeout(() => window.location.href = "results.html", 1000);
    }
  </script>
</body>
</html>
